  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Forum</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Forum</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <!-- Main row -->
        <div class="row">
          <!-- Left col -->
          <section class="col-lg-12 connectedSortable">
            <!-- Custom tabs (Charts with tabs)-->

            <main class="content">
              <div class="container p-0">

                <div class="card">
                  <div class="row g-0">
                    <div class="col-12 col-lg-5 col-xl-3 border-right">

                      <div class="px-4 d-none d-md-block">
                        <div class="d-flex align-items-center">
                          <div class="flex-grow-1">
                            <!-- <input type="text" class="form-control my-3" placeholder="Search..."> -->
                            Pengguna Aktif
                          </div>
                        </div>
                      </div>

                      <div id="user-online">
                        
                      </div>
                      <!-- <a href="#" class="list-group-item list-group-item-action border-0" id="buka-chat">
                        <div class="badge bg-success float-right">5</div>
                        <div class="d-flex align-items-start">
                          <img src="https://bootdey.com/img/Content/avatar/avatar5.png" class="rounded-circle mr-1" alt="Vanessa Tucker" width="40" height="40">
                          <div class="flex-grow-1 ml-3">
                            Vanessa Tucker
                            <div class="small"><span class="fas fa-circle chat-online"></span> Online</div>
                          </div>
                        </div>
                      </a> -->

                      <hr class="d-block d-lg-none mt-1 mb-0">
                    </div>
                    <div class="col-12 col-lg-7 col-xl-9 width-chat" id="chat">
                      <div class="py-2 px-4 border-bottom d-none d-lg-block">
                        <div class="d-flex align-items-center py-1">
                          <div class="position-relative">
                            <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                          </div>
                          <div class="flex-grow-1 pl-3">
                            <strong id="id_user"></strong>
                            <!-- <div class="text-muted small"><em>Typing...</em></div> -->
                          </div>
                          <div>
                            <!-- <button class="btn btn-primary btn-lg mr-1 px-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-phone feather-lg"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></button>
                            <button class="btn btn-info btn-lg mr-1 px-3 d-none d-md-inline-block"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video feather-lg"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button> -->
                            <button class="btn btn-light border btn-lg px-3" id="akhiri-chat">Akhiri Obrolan</button>
                          </div>
                        </div>
                      </div>

                      <div class="position-relative">
                        <div class="chat-messages p-4">

                          <!-- <div class="chat-message-right pb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:33 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                              <div class="font-weight-bold mb-1">You</div>
                              Lorem ipsum dolor sit amet, vis erat denique in, dicunt prodesset te vix.
                            </div>
                          </div>

                          <div class="chat-message-left pb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:34 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                              <div class="font-weight-bold mb-1">Sharon Lessman</div>
                              Sit meis deleniti eu, pri vidit meliore docendi ut, an eum erat animal commodo.
                            </div>
                          </div>

                          <div class="chat-message-right mb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:35 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                              <div class="font-weight-bold mb-1">You</div>
                              Cum ea graeci tractatos.
                            </div>
                          </div>

                          <div class="chat-message-left pb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:36 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                              <div class="font-weight-bold mb-1">Sharon Lessman</div>
                              Sed pulvinar, massa vitae interdum pulvinar, risus lectus porttitor magna, vitae commodo lectus mauris et velit.
                              Proin ultricies placerat imperdiet. Morbi varius quam ac venenatis tempus.
                            </div>
                          </div>

                          <div class="chat-message-left pb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:37 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                              <div class="font-weight-bold mb-1">Sharon Lessman</div>
                              Cras pulvinar, sapien id vehicula aliquet, diam velit elementum orci.
                            </div>
                          </div>

                          <div class="chat-message-right mb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:38 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                              <div class="font-weight-bold mb-1">You</div>
                              Lorem ipsum dolor sit amet, vis erat denique in, dicunt prodesset te vix.
                            </div>
                          </div>

                          <div class="chat-message-left pb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:39 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                              <div class="font-weight-bold mb-1">Sharon Lessman</div>
                              Sit meis deleniti eu, pri vidit meliore docendi ut, an eum erat animal commodo.
                            </div>
                          </div>

                          <div class="chat-message-right mb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:40 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                              <div class="font-weight-bold mb-1">You</div>
                              Cum ea graeci tractatos.
                            </div>
                          </div>

                          <div class="chat-message-right mb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:41 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                              <div class="font-weight-bold mb-1">You</div>
                              Morbi finibus, lorem id placerat ullamcorper, nunc enim ultrices massa, id dignissim metus urna eget purus.
                            </div>
                          </div>

                          <div class="chat-message-left pb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:42 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                              <div class="font-weight-bold mb-1">Sharon Lessman</div>
                              Sed pulvinar, massa vitae interdum pulvinar, risus lectus porttitor magna, vitae commodo lectus mauris et velit.
                              Proin ultricies placerat imperdiet. Morbi varius quam ac venenatis tempus.
                            </div>
                          </div>

                          <div class="chat-message-right mb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:43 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                              <div class="font-weight-bold mb-1">You</div>
                              Lorem ipsum dolor sit amet, vis erat denique in, dicunt prodesset te vix.
                            </div>
                          </div>

                          <div class="chat-message-left pb-4">
                            <div>
                              <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                              <div class="text-muted small text-nowrap mt-2">2:44 am</div>
                            </div>
                            <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                              <div class="font-weight-bold mb-1">Sharon Lessman</div>
                              Sit meis deleniti eu, pri vidit meliore docendi ut, an eum erat animal commodo.
                            </div>
                          </div>
                           -->
                           <div id="list-chat">
                             
                           </div>
                        </div>
                      </div>

                      <div class="flex-grow-0 py-3 px-4 border-top">
                        <div class="input-group">
                          <input type="text" id="chatSend" class="form-control" placeholder="Type your message">
                          <button class="btn btn-primary" id="send">Send</button>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </main>

            <!-- /.card -->
          </section>
          <!-- right col -->
        </div>
        <!-- /.row (main row) -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <input type="hidden" name="id" id="id_sess" value="<?php echo $this->session->userdata('id') ?>">
  <input type="hidden" name="id" id="id_user2" >
  <audio id="xyz" src="<?php echo base_url()?>assets/alert.mp3" preload="auto"></audio>
  <script src="<?php echo base_url()?>assets/plugins/jquery/jquery.min.js"></script>
  <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
  <script type="text/javascript">

     // Enable pusher logging - don't include this in production
    Pusher.logToConsole = true;

    var pusher = new Pusher('d7ba73c0cdae705ec5b7', {
      cluster: 'ap1'
    });

    var channel = pusher.subscribe('my-channel');
    channel.bind('my-event', function(data) {
      // alert(JSON.stringify(data));
      console.log(data)
      console.log(data.id)
      console.log(data.id, data.tujuan)
      var id_user2 = document.getElementById('id_user2').value;
      var id_user = document.getElementById('id_sess').value;
      if(data.tujuan == id_user){
        document.getElementById('xyz').play();
        // getChat2(id_user);
      }

      getChat(id_user2);
      getbaca2(id_user2);
      getuser();
    });
    getuser();
    function getuser(){
      $.ajax({
       url : '<?php echo base_url()?>dashboard/getuser',
       type: 'GET',
       dataType : "JSON",
       success:function(data){
        console.log(data)
        if(data.length > 0){
        var html = "";
        for (var i = 0; i < data.length; i++) {
          html += '<a href="#" class="list-group-item list-group-item-action border-0" id="buka-chat" data-id='+data[i].session_id+' data-nama='+data[i].nama+'>'+
                        '<div class="badge bg-success float-right" id='+data[i].session_id+'></div>'+
                        '<div class="d-flex align-items-start">'+
                          '<img src="https://bootdey.com/img/Content/avatar/avatar5.png" class="rounded-circle mr-1" alt="Vanessa Tucker" width="40" height="40">'+
                          '<div class="flex-grow-1 ml-3">'+ data[i].nama +'<div class="small"><span class="fas fa-circle chat-online"></span> Online</div>'+
                         ' </div>'+
                        '</div>'+
                      '</a>'
                      getbaca2(data[i].session_id);
        }
        $('#user-online').html(html)
       }else{
        html = 'Tidak Ada User Online';
         $('#user-online').html(html)
       }
     }
     })
    }
   

    $(document).on('click', '#buka-chat', function(){
      var id = document.getElementById('chat');
      id.classList.remove('width-chat');
      var data_id = $(this).data('id');
      var data_nama = $(this).data('nama');
      $('#id_user').html(data_nama);
      $('#id_user2').val(data_id);
      gabung(data_id);
      
    })
     $(document).on('click', '#akhiri-chat', function(){
      var id = document.getElementById('chat');
      id.classList.add('width-chat');
    })
     function gabung(id_user){
      console.log(id_user)
      var id_admin = document.getElementById('id_sess').value;
      $.ajax({
        url : '<?php echo base_url()?>dashboard/gabung',
        type: 'POST',
        data: {id_user:id_user},
        dataType : "JSON",
        success:function(data){
           getChat(id_user);
        }
      });
     }
     function getChat(id){
      console.log(id)
       $.ajax({
        url : '<?php echo base_url()?>dashboard/tampil_chat',
        type: 'POST',
        data: {id:id},
        dataType : "JSON",
        success:function(data){
          console.log(data)
          if(data.length > 0){
            var html = "";
            for (var i = 0; i < data.length; i++) {
              if (data[i].user_2 == id) {
                 html += '<div class="chat-message-right mb-4">'+
                            '<div>'+
                              '<img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">'+
                              '<div class="text-muted small text-nowrap mt-2">2:43 am</div>'+
                            '</div>'+
                            '<div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">'+
                              '<div class="font-weight-bold mb-1">Saya</div>'+data[i].pesan+'</div>'+
                          '</div>';
              }else{

                html += '<div class="chat-message-left pb-4">'+
                            '<div>'+
                              '<img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">'+
                              '<div class="text-muted small text-nowrap mt-2">2:44 am</div>'+
                            '</div>'+
                            '<div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">'+
                              '<div class="font-weight-bold mb-1">'+data[i].nama_saya+'</div>'+data[i].pesan+'</div>'+
                          '</div>';
              }

              $('#list-chat').html(html);
            }

          }else{
            html = '<div class="text-center pb-4">Belum ada obrolan</div>';
             $('#list-chat').html(html);
          }
          getbaca();
          getbaca2(id);
        }
      })
     }
     function getChat2(id){
       $.ajax({
        url : '<?php echo base_url()?>dashboard/tampil_chat2',
        type: 'POST',
        data: {id:id},
        dataType : "JSON",
        success:function(data){
          console.log(data)
            var html = "";

            for (var i = 0; i < data.length; i++) {
              if (data[i].user_2 == id) {
                document.getElementById('xyz').play();
              }else{

              }
            }
        }
      })
     }
     $(document).on('click', '#send', function(e){
      e.preventDefault();
      var id = $('#id_sess').val();
      var id_user2 = $('#id_user2').val();
      var pesan = $('#chatSend').val();
      console.log(pesan)
       if(pesan != ""){
        $.ajax({
        url : '<?php echo base_url()?>dashboard/sendMessage',
        type: 'POST',
        data: {pesan:pesan, id:id, id_user2:id_user2},
        dataType : "JSON",
        success:function(response){
          if(response.error){
            swal("Gagal", response.massage, "error");
          }else{
            $('#id_session').val(response.id);
            $('#chatSend').val("");
            getchat();
          }
        }
      })
      }else{
        swal({title: "Peringatan!", text: "Chat masih kosong", type: "warning"},
            function(){ 
              // location.reload(true);
            });
      }
    })
    function getbaca(){
    $.ajax({
       url : '<?php echo base_url()?>dashboard/baca',
       type: 'GET',
       dataType : "JSON",
       success:function(data){
          console.log(data)
          $('#count-baca').html(data);
       }
    })
  } 
  function getbaca2(id){
   var dataid = '#'+id;
   console.log(dataid)
    $.ajax({
       url : '<?php echo base_url()?>dashboard/baca2',
       type: 'POST',
       data:{id:id},
       dataType : "JSON",
       success:function(data){
          console.log(data)
          if(data > 0){
            $(""+dataid+"").html(data);
          }else{
            $(""+dataid+"").html("");
          }
          
       }
    })
  }

  </script>